# 图床API安全指南

## 安全设计概述

我们的图床API采用了以下安全措施来保护上传过程：

1. **服务器端令牌生成**：所有上传令牌由服务器生成，绝不在前端暴露密钥
2. **临时令牌**：所有令牌都有过期时间，默认3600秒
3. **用户身份验证**：只有已登录用户才能获取上传令牌
4. **请求签名**：每个上传请求都包含时间戳和签名，防止请求被篡改
5. **HMAC-SHA1签名**：使用安全的哈希算法生成签名

## 安全实现方式

### 服务器端

1. **配置隔离**：
   - 访问密钥（AccessKey）和密钥（SecretKey）存储在服务器配置中
   - 绝不在前端代码或响应中暴露SecretKey

2. **令牌生成**：
   - 服务器使用HMAC-SHA1算法生成签名
   - 签名内容包括请求方法、过期时间和存储路径
   - 将AccessKey、签名和过期时间组合成令牌

3. **权限控制**：
   - 只有已认证用户才能获取上传令牌
   - 管理员可以有额外的图片管理权限

### 客户端

1. **令牌获取**：
   - 客户端先认证登录，获取Cookie或JWT令牌
   - 使用认证信息从服务器获取临时上传令牌

2. **文件上传**：
   - 将临时令牌附加到上传请求中
   - 图床服务验证令牌的签名和过期时间
   - 上传成功后返回图片链接

## 安全最佳实践

1. **定期轮换密钥**：
   - 定期更新AccessKey和SecretKey
   - 密钥泄露时立即更换

2. **日志记录和监控**：
   - 记录所有图片上传操作
   - 监控异常上传行为

3. **内容检查**：
   - 服务端验证文件类型
   - 限制文件大小
   - 可选择实现图片内容扫描

4. **域名和路径保护**：
   - 使用HTTPS保护所有API通信
   - 考虑为敏感图片设置防盗链

## 与多吉云的异同

我们的实现参考了多吉云的API设计，但有以下改进：

1. **客户端隔离**：
   - 多吉云API支持客户端直接签名
   - 我们的实现只在服务器端进行签名，更安全

2. **用户级别隔离**：
   - 每个用户只能获取自己的上传令牌
   - 令牌与用户身份绑定

## 故障排查

常见问题及解决方案：

1. **"令牌无效"错误**：
   - 检查令牌格式是否正确
   - 验证令牌是否过期
   - 确认AccessKey是否正确

2. **"签名验证失败"错误**：
   - 确认使用了正确的SecretKey
   - 检查签名字符串格式

3. **上传失败**：
   - 检查网络连接
   - 确认文件大小和类型符合要求
   - 验证令牌权限 